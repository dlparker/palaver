#+TITLE: Story 004: Add Tests for Modular Server Architecture
#+AUTHOR: Claude Code
#+DATE: 2025-12-27
#+PROPERTY: STORY_ID 004
#+PROPERTY: STAGE Prototype
#+PROPERTY: STATUS Draft

* Story Overview

** Title
Add comprehensive tests for refactored server architecture

** Story ID
004

** Stage
Prototype

** Status
Draft

* Description

Add test coverage for the modular server architecture introduced in Story 003. Tests should focus on:
- Direct testing of EventRouter (no HTTP stack)
- Testing router factories with minimal FastAPI test infrastructure
- Integration testing with mocked audio input (following existing test patterns)
- Full server integration with draft completion monitoring

This establishes the testing foundation for the Prototype stage architecture, enabling confident iteration and future extensions.

** Testing Strategy

*** 1. Unit Test: EventRouter (=tests/test_event_router.py=)
- Test EventRouter directly as pure Python component (no FastAPI/HTTP)
- Mock websocket objects for client registration/unregistration
- Test event routing logic (server-side filtering, "all" subscription, AudioChunkEvent filtering)
- Test event serialization (dataclasses, numpy arrays, nested structures)
- Verify in_speech filtering for AudioChunkEvent
- Fast, isolated, easy to debug

*** 2. Unit Test: Status Router (=tests/test_status_router.py=)
- Use FastAPI TestClient for synchronous HTTP testing
- Create minimal test app with status router
- Test /health endpoint (basic health check)
- Test /status endpoint (pipeline state, client count, model path)
- Mock EventNetServer for shared context
- No actual pipeline startup (just router logic)

*** 3. Integration Test: Event Streaming with Mock Audio (=tests/test_event_streaming.py=)
- Combine MockStream pattern from =test_mic_mock_to_text.py=
- Use websocket test client (FastAPI websocket testing or httpx)
- Feed audio file through mocked MicListener
- Verify events flow through websocket
- Monitor draft completion (pattern from =test_file_audio_to_text.py=)
- Test subscription protocol ("all", explicit event types)
- Verify server-side filtering and VAD routing

*** 4. Full Server Integration Test (=tests/test_server_integration.py=)
- Test complete EventNetServer with both routers
- Mock audio input, verify draft recording
- Test /health and /status endpoints during pipeline operation
- Verify client count updates in /status
- Test graceful shutdown
- End-to-end validation of Story 003 architecture

** File Structure
#+begin_src
tests/
├── test_event_router.py           # Unit test - EventRouter
├── test_status_router.py          # Unit test - status router
├── test_event_streaming.py        # Integration - websocket + mock audio
└── test_server_integration.py    # Integration - full server
#+end_src

** Acceptance Criteria

1. EventRouter unit tests cover routing logic, filtering, and serialization
2. Status router tests verify /health and /status endpoints
3. Event streaming test verifies websocket subscription and event flow
4. Integration test verifies full server operation with draft completion
5. Tests follow existing patterns (MockStream, draft monitoring)
6. Tests can run without actual microphone hardware
7. All tests pass with Prototype stage code quality

* Constraints

- Prototype stage testing: focus on interfaces and key functionality, not edge cases
- Reuse existing test patterns (MockStream, APIWrapper, draft monitoring)
- Direct router testing preferred over full HTTP stack where possible
- Use FastAPI's built-in test tools (TestClient, websocket testing)
- Tests should be fast and isolated (no network dependencies)
- Mock hardware dependencies (microphone, audio devices)
- Tests document the expected behavior of the modular architecture

* Tasks

** PLANNED Task 1: Unit test EventRouter - direct testing (palaver-kgp)
- Create =tests/test_event_router.py=
- Test client registration/unregistration
- Test event routing logic (subscriptions, "all" filtering)
- Test server-side filtering (AudioChunkEvent exclusion)
- Test event serialization (dataclasses, numpy arrays, nested structures)
- Test in_speech filtering for AudioChunkEvent
- No HTTP/FastAPI dependencies - pure Python unit test

** PLANNED Task 2: Unit test status router with TestClient (palaver-eaj)
- Create =tests/test_status_router.py=
- Use FastAPI TestClient for HTTP testing without network
- Test =/health= endpoint
- Test =/status= endpoint
- Mock EventNetServer for shared context
- No actual pipeline startup

** PLANNED Task 3: Integration test event streaming with mock audio (palaver-dbl)
- Create =tests/test_event_streaming.py=
- Reuse MockStream pattern from =test_mic_mock_to_text.py=
- Use websocket test client (FastAPI/httpx)
- Feed audio file through mocked MicListener
- Verify events flow through websocket
- Test subscription protocol ("all", explicit types)
- Monitor draft completion (pattern from =test_file_audio_to_text.py=)
- Dependencies: Task 1

** PLANNED Task 4: Full server integration test (palaver-olk)
- Create =tests/test_server_integration.py=
- Test complete EventNetServer with both routers
- Mock audio input, verify draft recording
- Test =/health= and =/status= endpoints during operation
- Verify client count updates in =/status=
- Test graceful shutdown
- End-to-end validation of Story 003 architecture
- Dependencies: Task 2, Task 3

* Implementation Notes

** 2025-12-27 Implementation started
- Created beads issues for all 4 tasks (palaver-kgp, palaver-eaj, palaver-dbl, palaver-olk)
- Set up task dependencies for proper ordering
- Approach: Layered testing from unit tests to integration tests

** 2025-12-27 Task 1 Complete - EventRouter unit tests (palaver-kgp)
- Created =tests/test_event_router.py= with pure Python unit tests
- No HTTP/FastAPI dependencies - MockWebSocket for testing
- 9 tests covering all routing logic, filtering, serialization
- 95% EventRouter coverage achieved
- Tests document expected behavior: "all" excludes AudioChunkEvent, in_speech filtering works

** 2025-12-27 Task 2 Complete - Status router tests (palaver-eaj)
- Created =tests/test_status_router.py= using FastAPI TestClient
- 5 tests covering /health and /status endpoints
- 100% status router coverage
- No network required - TestClient provides HTTP interface without actual networking
- Tests verify pipeline state, client count, draft recording status

** 2025-12-27 Tasks 1-2 progress
- Direct router testing pattern established and working well
- 82% overall test coverage achieved (user confirmed adequate)
- Two integration tests remaining (event streaming, full server)

* Review & Retrospective

[After implementation, captures review process and outcomes]

* Related Work

** Related Stories
- Story-003: Refactor Server Architecture (code being tested)
- Story-002: Optimize Event Streaming (functionality to preserve)
- Story-001: Event Net POC (original implementation)

** Beads Tasks
- palaver-kgp: Unit test EventRouter - direct testing
- palaver-eaj: Unit test status router with TestClient
- palaver-dbl: Integration test event streaming with mock audio
- palaver-olk: Full server integration test

** Git Commits
[To be populated during implementation]

* References

- Existing test patterns: =test_mic_mock_to_text.py=, =test_file_audio_to_text.py=
- FastAPI testing docs: https://fastapi.tiangolo.com/tutorial/testing/
- FastAPI websocket testing: https://fastapi.tiangolo.com/advanced/websockets/
- TestClient: https://www.starlette.io/testclient/
- Components under test: =src/palaver/fastapi/= (EventRouter, EventNetServer, routers)
